# Swarm

## Swarmとは
Docker Descktopのビルインのコンテナオーケストレーションツール。<br>
複数のDockerホストをまとめて、単一の仮想ホストとして機能させることができるようにするネイティブのクラスタリング機能

## Swarmの構成要素
- Swarm Manager(Manager Node)：クラスター（workerの集まり）の管理を行う
- Swarm Worker (Worker Node)：コンテナの実行を行う

## Swarmの仕組み
-----Manager Node-----------
1. コマンドを実行してサービスを作成（API）
1. サービスとタスクを指定の個数分作成（数量分loopする）（オーケストラー）
1. タスクにIPアドレスを割り当てる（アロケータ）
1. ノードにタスクを割り当てる（スケジューラ）
1. workerをチェックする（ディスパッチャ）<br>

--------Worker Nodo----------

6. 割り当てられたタスクを確認するためにManager Nodeのディスパッチャに接続する（Worker）
7. 割り当てられたタスクを実行。（Executor）

## Swarmのinitで行われること
- PKIとセキュリティの自動設定
 - ルートの認証書を作成
 - 最初のマネージャーノードに認証書を発行
 - Join tokenを作成
- root CAとconfigとsecretsを管理するための Raft databaseを作成

# Overlay Multiple-Host Networking
複数のホスト間での通信を仮想的に行う技術です。<br>
異なる物理的なネットワーク上にある複数のホストを同じ論理的なネットワーク上に配置することができる。<br>
この技術は、クラウドコンピューティングやデータセンターなど、多数のホストがある環境で利用されます。また、仮想化技術を使用することで、オーバーレイネットワーク上で新しい仮想マシンを追加することが容易になります。<br>

# SwarmでのOverlay Networkについて
- コンテナ間の通信が一つのSwarmで管理できる。
- そして、オプショナルなIPSecを使用することができる
- また、サービスを接続したり、しなかったりなど設計にあわせて柔軟に設定できる。

--driver overlayオプションをつけることで、オーバーレイネットワークを作成することができる。<br>

# Routing Mesh
複数のコンテナ間でのトラフィックを効率的かつ柔軟に転送するための機能。<br>
通常、オーケストレーターは、コンテナがどのノードにあるかを知っているため、トラフィックを特定のノードにルーティングします。しかし、Routing Meshを使用すると、コンテナのIPアドレスを直接指定する必要がなく、自動的にトラフィックを正しいコンテナに転送できます。

Routing Meshは、ロードバランシングやフェイルオーバー、サービスディスカバリーなど、多くのオーケストレーションタスクに役立ちます。また、アプリケーションのスケーラビリティや可用性を向上させることができます。

Swarmの場合、LinuxカーネルのIPVS（Linuxカーネルに組み込まれたロードバランサー）を使用して、Routing Meshを実装している。

# Routing Meshの実現方法
- Overlay Networkでコンテナ同士の通信をする（VIPを使用）
- それぞれのサービスにロードバランサを作成する方法（ingress networkというデフォルトの仮想ネットワークでつながっているので実現可能。）

※1つのネットワークか別々のネットワークかが大きな違い。しかし、どちらの場合でも、行われる機能としては同じ（ロードバランスして、それぞれのコンテナに振り分ける）

# IPVS
IPVS（IP Virtual Server）は、Linuxカーネルに組み込まれたロードバランサーです。IPVSは、ネットワークレイヤー（OSIモデルの第3層）で動作し、TCP/UDPトラフィックを分散するために使用されます。

IPVSは、クライアントからのリクエストを複数のサーバーに分散し、サーバーが実行するタスクを均等に分配することができます。IPVSは、バックエンドサーバーに対するトラフィックを効率的に転送するために、ネットワークアドレス変換（NAT）を使用します。

IPVSは、多くのロードバランシング手法をサポートしており、ラウンドロビン、ウェイト、LVS-NAT、LVS-TUN、LVS-DRなどのアルゴリズムが利用可能です。また、IPVSは、バックエンドサーバーの可用性を監視し、障害が発生した場合に自動的にトラフィックを他のサーバーに転送する機能も提供しています。

IPVSは、カーネルレベルで動作するため、通常のユーザースペースのロードバランサーと比較して高速で信頼性が高く、負荷分散に適しています。そのため、IPVSは、大規模なWebサイトやアプリケーション、クラウド環境など、高い負荷分散性能が求められる場面で広く使用されています

# Routing Meshのコネクションについての問題点
- ステートレスなロードバランサー
- OSI参照モデルのLayer3（TCP）のロードバランサ（Layer3（DNS）でないので、同じポートで複数のサイトを同じSwarmでは実現できない）

# 上記の問題点への解決策
- Nginx or HAProxyを使用する(Routing Meshの前に挟む)
- Docker Enterprise Editionを使用する（これだと、ビルドインでL4を使える）

# Swarm Stacks
Swarm Stacksは、Docker Composeファイルを使用して、複数のコンテナを定義し、それらをSwarm上にデプロイするための機能です。

Swarm Stacksは、複数のサービスを1つのアプリケーションとして定義することができます。これにより、アプリケーションの構成と管理が容易になります。Stacksは、アプリケーションの更新や変更の際にも役立ちます。Stacksを使用すると、アプリケーションの変更がSwarm上で自動的に更新されます。

Swarm Stacksは、高可用性やロードバランシングなど、複数のコンテナを使用するアプリケーションのデプロイに最適です。Swarm Stacksを使用することで、よりスケーラブルで信頼性の高いアプリケーションを作成することができます。

※composeファイルのバージョンは3以上

※Docker fileでComposeはdeployを無視し、Swarm Stacksのbuildを無視する。

# Swarm Secrets 

Swarmに登録した秘密情報を、任意のコンテナに共有できるもの。

Swarm Secretsは、Docker Swarm上で安全に秘密情報を管理するための機能。Swarm Secretsを使用すると、コンテナに秘密情報を直接渡すことなく、秘密情報を安全に管理することができます。

Swarm stacksを使用する場合は「secrets」キーワードを使用する。デプロイは、シークレットを使わないときと同じ。

Docker1.13.0からデフォルトでRaft DBが暗号化されて保存されるようになり、それを活用してSwarm Secretsを実現している。（managerのノードに保存される）

最初にSwarmにsecretを保存して、それが他のサービスにも割り当てられる。

※docker-composeでファイルベースでシークレットを共有することもできる。しかし、セキュアではない。(ファイルの場所を表記する方法ならOK)

※ ```「/run/secrets/<secret_name> or run/secrets/<secret_alias>」でマウントされる。```

# Control Plane
Dockerクラスターの状態を管理し、クラスター内の各ノードとの通信を担当するコンポーネントのこと。

クラスター内のすべてのノードの状態を管理するために使用されるいくつかのコンポーネントが含まれています。これらには、etcdやRaftなどの分散ストレージシステム、Swarm Manager、リバースプロキシなどが含まれます。これらのコンポーネントが連携して、Docker Swarmモードで高可用性、負荷分散、およびフェイルオーバーを提供します。(ほかにも、TLSやMutal Authの機能も)

## Control Planeに含まれているコンポーネント
- Swarm Manager: Swarm Managerは、クラスター内のノードを監視し、コンテナーのデプロイやスケーリング、ネットワーキングなどのタスクを管理するための中央の制御ポイントです。Swarm Managerは、クラスターの全体像を理解し、コンテナーのプレイスメントに関する決定を下すことができます。

- Raftデータベース: Raftデータベースは、Swarm Managerの状態を保存するために使用されます。Raftは、分散一貫性のあるログと状態マシンを提供する一般的な分散一貫性のあるアルゴリズムです。

- etcd: etcdは、分散キー/値ストアであり、Swarm Managerの状態を保存するために使用されます。etcdは、Swarm Managerのハイアベイラビリティをサポートするために複数のレプリカで実行されます。

- DNSサービスディスカバリ: DNSサービスディスカバリは、コンテナーに割り当てられた名前を解決するために使用されます。Docker Swarmは、コンテナーが動的に生成されるため、DNSを使用してコンテナーを特定する必要があります。

- ロードバランサー: ロードバランサーは、入力トラフィックを受信し、クラスター内のコンテナーにトラフィックを分配するために使用されます。Docker Swarmでは、Nginx、HAProxy、またはDocker Flow Proxyなどのロードバランサーを使用できます。